# LandPPT Python-Only Docker Image
# Minimal Python installation without system packages

FROM python:3.11-slim

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONPATH=/app/src

# Create non-root user (using existing tools only)
RUN groupadd -r landppt && useradd -r -g landppt landppt

# Set work directory
WORKDIR /app

# Install only core Python packages (minimal set)
RUN pip install --no-cache-dir \
    fastapi==0.104.1 \
    uvicorn==0.24.0 \
    pydantic==2.5.0 \
    python-multipart==0.0.6 \
    jinja2==3.1.2 \
    aiofiles==23.2.1 \
    httpx==0.25.0 \
    requests==2.31.0 \
    sqlalchemy==2.0.23 \
    aiosqlite==0.19.0 \
    openai==1.3.0 \
    python-dotenv==1.0.0 \
    click==8.1.7 \
    rich==13.7.0 \
    pydantic-settings==2.1.0

# Copy application code
COPY src/ ./src/
COPY run.py setup_database.py ./
COPY template_examples/ ./template_examples/

# Create simple scripts inline
RUN echo '#!/bin/bash\necho "ðŸš€ Starting LandPPT..."\nmkdir -p data uploads temp/ai_responses_cache temp/style_genes_cache temp/summeryanyfile_cache temp/templates_cache research_reports lib/Linux lib/MacOS lib/Windows\nexec "$@"' > entrypoint.sh && \
    chmod +x entrypoint.sh

RUN echo '#!/bin/bash\npython -c "import urllib.request; urllib.request.urlopen(\"http://localhost:8000/health\")"' > health-check.sh && \
    chmod +x health-check.sh

# Create necessary directories
RUN mkdir -p temp/ai_responses_cache \
    temp/style_genes_cache \
    temp/summeryanyfile_cache \
    temp/templates_cache \
    research_reports \
    lib/Linux \
    lib/MacOS \
    lib/Windows \
    uploads \
    data \
    && chown -R landppt:landppt /app

# Switch to non-root user
USER landppt

# Expose port
EXPOSE 8000

# Health check using Python only
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')" || exit 1

# Set entrypoint and default command
ENTRYPOINT ["./entrypoint.sh"]
CMD ["python", "run.py"]
